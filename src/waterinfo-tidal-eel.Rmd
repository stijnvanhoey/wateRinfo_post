---
slug: "waterinfo-tidal-eel"
title: wateRinfo - Downloading tidal data to understand the behaviour of a migrating eel
authors:
  - name: Stijn Van Hoey
    url: https://orcid.org/0000-0001-6413-3185
    twitter: SVanHoey
  - name: Peter Desmet
    url: https://orcid.org/0000-0002-8442-8025
    twitter: peterdesmet
date: 2019-01-15
categories: blog
tags:
  - software-peer-review
  - r
  - package
  - water
  - data-access
  - tidal-data
  - fishes
  - movement-data
  - acoustic-telemetry
output:
  html_document:
    df_print: kable
  md_document:
    df_print: kable
    preserve_yaml: true
    variant: markdown_github
always_allow_html: yes
knit: (function(input_file, encoding) {
  rmarkdown::render(input_file, encoding = encoding, output_dir = "../docs") })
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

> Do you know what that sound is, Highness? Those are the Shrieking Eels â€” if you don't believe me, just wait. They always grow louder when they're about to feed on human flesh. If you swim back now, I promise, no harm will come to you. I doubt you will get such an offer from the Eels.
> 
> _Vizzini, [The Princess Bride](https://youtu.be/KGcat9tGZVU)_

European eels ([_Anguilla anguilla_](https://en.wikipedia.org/wiki/Anguilla_anguilla)) have it tough. Not only are they depicted as monsters in movies, they are [critically endangered](https://doi.org/10.2305/IUCN.UK.2014-1.RLTS.T60344A45833138.en) in real life. One of the many aspects that is contributing to their decline is the reduced connectivity between their freshwater and marine habitats. Eels are catadromous: they live in freshwater, but migrate to the Sargasso Sea to spawn, a route that is blocked by numerous human structures (shipping locks, sluices, pumping stations, etc.). [Pieterjan Verhelst](http://www.marinebiology.ugent.be/node/68491) studies the impact of these structures on the behaviour of eels, making use of the [fish acoustic receiver network](http://lifewatch.be/en/fish-acoustic-receiver-network) that was established as part of the Belgian LifeWatch observatory. This animated video gives a quick introduction to his research and the receiver network:

[![Tagging research on eel in Belgium](https://img.youtube.com/vi/7YQVgl3QPyY/0.jpg)](https://www.youtube.com/watch?v=7YQVgl3QPyY)

In this blog post, we'll explore if the migration of one eel is influenced by the tide. It's a research use case for our R package [wateRinfo](https://ropensci.github.io/wateRinfo/), which was recently [peer reviewed](https://github.com/ropensci/software-review/issues/255) (thanks to reviewer [Laura DeCicco](https://github.com/ldecicco-USGS) and editor [Karthik Ram](https://github.com/karthik) for their constructive feedback!) and accepted as a community-contributed package to [rOpenSci](https://github.com/ropensci/wateRinfo).

## Eel tracking data

Let's start with the tracking data of the eel and check the favorite places of our tagged eel to hang out in the Scheldt estuary.

```{r message=FALSE, warning=FALSE}
```{r}
library(tidyverse)
library(lubridate)
library(here)
library(leaflet)
library(ggridges)
library(ggpubr)
```

```{r echo=FALSE}
eel <- read_csv("../data/eel_track.csv", col_types = cols())
```

The eel tracking data contains the residence time intervals between the `Arrival` and `Departure` of an eel, supplied with a `Transmitter`, at a certain `Receiver` station. Each `Receiver` station does have a `latitude`, `longitude` and a `station` name:

```{r echo=FALSE}
head(eel) %>% knitr::kable()
```

For each interval, the number of raw detections of the `Receiver` for each `Transmitter` is provided together with the derived `residencetime` of the `Transmitter`, i.e. the eel. As such, we can calculate the eel *favourite place to hang out* by calculating the total residence time around each receiver.

On a map, this looks like:

```{r echo=FALSE}
residence <- eel %>% 
    group_by(Receiver, latitude, longitude, Transmitter) %>%
    summarise(total_residence = sum(residencetime))
```

```{r echo=FALSE}
#tag_colors <- colorFactor(c("#e66101", "#5e3c99"), eels$Transmitter)

m <- leaflet(data = residence, width = 600, height = 400) %>%
  addTiles() %>%  
  addCircleMarkers(~longitude, ~latitude, popup = ~Receiver, color = "#e66101",
                   radius = ~total_residence/3600, stroke = FALSE, fillOpacity = 0.6)
m
```

Apparently, the eel carrying transmitter `A69-1601-52622` likes to be around the municipality Hamme and a section between the municipalities Wetteren and Wichelen.

For the remainder of this post, let's give a more compelling name than the Transmitter code she is carrying. So, the eel with transmitter `A69-1601-52622` is officially named **Buttercup**.

The map overview with total residence time lacks temporal information. We do not know *when* the eel are passing these receiver stations. Let's reconfigure adn plot the eel tracking data to see their route in the Scheldt river as function of time:

```{r}
eel <- eel %>%
    mutate(eel_name = recode(Transmitter, 
                             `A69-1601-52644` = "Buttercup"))
```

```{r echo=FALSE}
distance_from_sea <- read_csv("../data/distance_from_sea.csv", col_types = cols())
eel <- eel %>%
    left_join(distance_from_sea, by = "station")
```

```{r echo=FALSE}
station_municipality <- read_csv("../data/link_station_municipality.csv", col_types = cols())
station_municipality <- station_municipality %>% 
    left_join(eel %>% select(station, distance_to_refence_station) %>% 
              distinct(), by = "station") %>%
  add_row(municipality = "reference station" , 
          distance_to_refence_station = 0)
```

```{r echo=FALSE}
head(eel) %>% knitr::kable()
```

```{r echo=FALSE, fig.height=8, fig.width=10}

# create custom y-ax labels by combing distance and name
y_axis_label <- paste0(
  station_municipality$municipality, " (", 
  as.character(round(station_municipality$distance_to_refence_station/1000)), 
  " km)")

# convert Arrival and Departure to indidivual rows (tidy)
eel_gather <- eel %>%
  gather(action, datetime, c(Arrival, Departure))

# calculate location to put the towards sea arrow
date_plot_sea <- min(eel$Date) + (max(eel$Date) - min(eel$Date))/2

ggplot(eel_gather, aes(x = datetime, 
                       y = distance_to_refence_station,
                       color = eel_name)) +
    xlab("") + ylab("") +
    geom_line(alpha = 1., color = "#e66101", 
              linetype = "solid", size = 0.8) +
    scale_y_continuous("Municipalities along the Scheldt Estuary with\ndistance (km) to reference station at sea", 
                      breaks = station_municipality$distance_to_refence_station,
                      labels = y_axis_label) +  
    scale_color_manual(values = c("#e66101", "#5e3c99"), guide = guide_legend()) +
    annotate("text", x = as_datetime(date_plot_sea),
             y = max(eel$distance_to_refence_station) * 0.23, 
             colour = "#2b8cbe", label = "Sea", size = 5) +
    annotate("segment", x = as_datetime(date_plot_sea), xend = as_datetime(date_plot_sea),
             y = max(eel$distance_to_refence_station) * 0.2, 
             yend = max(eel$distance_to_refence_station) * 0.1, 
             arrow = arrow(length = unit(0.5, "cm")), 
             color = "#2b8cbe", size = 0.8) +
    theme_minimal() +
    theme(legend.position = c(.98, .99),
          legend.justification = c("right", "top"),
          legend.box.just = "right",
          legend.margin = margin(6, 6, 6, 6),
          legend.background =  element_rect(fill = "white", color = "transparent"),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.text = element_text(size = 10)) +
    guides(color = guide_legend(title = "Eel"))
```

We picked up the signal around Ghent/Merelbeke and Buttercup resided for a while in the Scheldt river before migration towards the sea. Once left, they start their long journey towards the Sargasso Sea. 

The periodic movement pattern of Buttercup during the second half of november 2016 is of particular interest, as it looks like a tidal frequency. It would be interesting to compare the movement pattern with real water level data from the Scheldt river...  that's what the [wateRinfo](https://inbo.github.io/wateRinfo/) package is all about.

**Note:**
To represent the data along a straight line (y-axis), we calculated the distances from each station to a reference station close to the sea (`ws-DL7`) . We used a `costDistance` function to derive the distances along the Scheldt river. Interested? See [the code repository](https://github.com/stijnvanhoey/wateRinfo_post) for more the details on the derivation.

### Tidal data from Waterinfo

[Waterinfo.be](http://waterinfo.be), managed by the [Flemisch Environmental agency (VMM)](https://en.vmm.be/) and [Flanders Hydraulics Research (WL)](https://www.waterbouwkundiglaboratorium.be/en/home), is a great resource for a wide set of abiotic variables. The water height of the Scheldt river is among these variables, providing detailed information of [tidal conditions](https://www.waterinfo.be/default.aspx?path=NL/Thema/Getij_Actueel). 

However, downloading the data from the website is both tedious (too much clicking) and not repeatable for future analysis. The goal of our [wateRinfo package](https://github.com/inbo/wateRinfo) is to facilitate access to the variety of data by providing an R interface to download time series data. We will use the package to access tidal/waterheight data.

For installation instructions, see [the package documentation](https://inbo.github.io/wateRinfo/). As wateRinfo is not registered on CRAN, you will need the `devtools` package to install the wateRinfo package. Once installed, load the library:

```{r echo=TRUE}
library(wateRinfo)
```

As water levels in the Scheldt river are not among their core supported variables, we use the tidal stations overview as currently discussed on the wateRinfo [GitHub issues](https://github.com/inbo/wateRinfo/issues/11#issuecomment-442901628). This list of station identifiers is precompiled to derive all tidal VMM/WL station timeseries:

```{r echo=FALSE}
ts_id_tide <- read_csv("../data/scheldt_tide_waterinfo_identifiers.csv", col_types = cols())

non_scheldt_stations <- c("Walem tij/Rupel", "Duffel-sluis tij", "Lier Molbrug tij/Nete",
                           "Kessel tij/Grote Nete", "Emblem tij/Kleine Nete", 
                           "Mechelen Benedensluis tij/Dijle", "Mechelen Stuw Opwaarts tij/Dijle",
                           "Hombeek tij/Zenne", "Zemst tij/Zenne", "Gentbrugge tij/Zeeschelde",
                           "Waasmunster Manta tij/Durme", "Duffel Sluis tij/Nete", 
                           "Mechelen Stuw Afwaarts tij/Dijle")
ts_id_tide <- ts_id_tide %>%
    filter(ts_id < 100000000) %>% # hack to exclude unworking ids
    filter(!station_name %in% non_scheldt_stations) %>% # exclude non-scheldt stations
    filter(ts_name == "Pv.10")  # only the 10 min series
```

The following list provides an overview of the time series identifiers of the relevant measurement stations along the Scheldt River with a 10 minute interval:

```{r echo=FALSE}
head(ts_id_tide) %>% knitr::kable()
```

Or shown on a map:

```{r echo=FALSE}
m <- leaflet(data = ts_id_tide, width = 600, height = 400) %>%
  addTiles() %>%  
  addCircleMarkers(~station_longitude, ~station_latitude, popup = ~station_name, 
                   stroke = FALSE, fillOpacity = 0.6, fillColor = "#2b8cbe")
m
```

[This vignette](https://inbo.github.io/wateRinfo/articles/download_timeseries_batch.html) of the wateRinfo package provides the example code to download the data for multiple stations at once using the `tidyverse verbs`. We use a similar approach, but instead of manually providing the start (`from`) and end (`to`) data, we get these from the eels tracking data period:

```{r}
start_tracking_period <- min(eel$Date)
end_tracking_period <- max(eel$Date)

tidal_data <- ts_id_tide %>%
    group_by(ts_id) %>%
    do(get_timeseries_tsid(.$ts_id,
                           from = start_tracking_period,
                           to = end_tracking_period,
                           datasource = 4)) %>%
    ungroup() %>%
    left_join(ts_id_tide, by = "ts_id")
```

```{r echo=FALSE}
#tidal_data <- read_csv("../data/tidal_data.csv", col_types = cols())
```

In just a few lines R code, we downloaded for each of the tidal measurement stations the data for the required time period. Make sure to check out the other tutorials as well on the [wateRinfo package website](https://inbo.github.io/wateRinfo/index.html).

The water level is expressed in meter TAW (or mTAW, meter above mean sea level). By combining `dplyr` and `ggplot2`, we can plot the data of the station in Dendermonde during November 2016:

```{r, fig.height=3, fig.width=8}
tidal_plot <- tidal_data %>% 
    filter(station_name %in% c("Dendermonde tij/Zeeschelde")) %>%
    filter(Timestamp > "2016-10-31", Timestamp <= "2016-11-30") %>%
    ggplot() +
        geom_line(aes(x = Timestamp, y = Value), color = "#2b8cbe") +
        scale_x_datetime(date_labels = "%Y-%m-%d",
                         date_breaks = "7 days") +
        facet_grid(rows = vars(station_name)) +
        theme_minimal() + ylab("Water level (mTAW)") + xlab("")
tidal_plot
```

**Note:** TAW means [*Tweede Algemene Waterpassing*](https://nl.wikipedia.org/wiki/Tweede_Algemene_Waterpassing), a reference height for Belgium

As such, we have all the bits and pieces together to combine the tidal data set with the tracking data of Buttercup during the second half of november 2016 and verify if Buttercup is using the tide to move around.

## Is Buttercup using the tide?

To represent the data of all the individual stations together with the tracks, we'll have to figure out an alternative way. One way to combine all tidal data in a single plot is to use its respective location in the Scheldt river and translate the water height in ridges instead of lines, as provided by the [`ggridges` package](https://cran.r-project.org/web/packages/ggridges/vignettes/gallery.html):

```{r message=FALSE, warning=FALSE}
library(ggridges)
```

```{r echo=FALSE}
tidal_data <- tidal_data %>%
    left_join(distance_from_sea, by = c("station_name" = "station")) %>%
    filter(station_name != 'Hemiksem tij/Zeeschelde')  # exclude data from Hemiksem
```

By extending the plot of the tracking data of Buttercup with the water levels measured in tidal measurement statsions, we can verify the eel movement pattern and the possible link with the water level data:

```{r echo=FALSE, warning=FALSE}
start_moment <- "2016-11-14"
end_moment <- "2016-11-22 12:00"
transmitter_selected <- "A69-1601-52644"
```

```{r echo=FALSE, warning=FALSE}
eels_subset <- eel %>% 
    filter(Departure >= start_moment, Arrival <= end_moment, 
           Transmitter == transmitter_selected)

tidal_data_subset <- tidal_data %>% 
    filter(Timestamp >= start_moment, 
           Timestamp <= end_moment)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10}
library(ggpubr)

# combine the eel tracking data with the tidal data representation
date_plot_sea <- tidal_data_subset %>%
    select(Timestamp) %>%
    pull() %>% median()

# convert Arrival and Departure to indidivual rows (tidy)
eels_gather <- eels_subset %>%
  gather(action, datetime, c(Arrival, Departure))

# create custom y-ax labels by combing distance and name
y_axis_label <- paste0(
  station_municipality$municipality, " (", 
  as.character(round(station_municipality$distance_to_refence_station/1000)), 
  " km)")

# create the eel track combined with ggridges water level plot
tidal_tracks <- ggplot() +
    geom_ridgeline(data = tidal_data_subset,
                   aes(x = Timestamp, y = distance_to_refence_station,
                       height = Value, group = distance_to_refence_station),
                   scale = 1000, fill = "#9ecae1", color = "#2b8cbe") +
    geom_line(data = eels_gather, aes(x = datetime,
                                      y = distance_to_refence_station),
              alpha = 1., color = "#e66101", linetype = "solid", size = 1) +
    scale_x_datetime(date_labels = "%d %b",
                     date_breaks = "1 days") +
    theme_minimal() +
    xlab("") + ylab("") +
    scale_y_continuous("Municipalities along the Scheldt Estuary with\ndistance (km) to reference station at sea",
                       breaks = station_municipality$distance_to_refence_station,
                       labels = y_axis_label) +
    annotate("text", x = as_datetime(date_plot_sea),
             y = max(eels_subset$distance_to_refence_station) * 0.23,
             colour = "#2b8cbe", label = "Sea", size = 5) +
    annotate("segment", x = as_datetime(date_plot_sea), xend = as_datetime(date_plot_sea),
             y = max(eels_subset$distance_to_refence_station) * 0.2,
             yend = max(eels_subset$distance_to_refence_station) * 0.1,
             arrow = arrow(length = unit(0.5, "cm")), color = "#2b8cbe",
             size = 0.8) +
    theme(panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank(),
          axis.text = element_text(size = 10))

# create a water level plot of Dendermonde
tide_dendermonde <- ggplot() +
    geom_line(data = tidal_data_subset %>% filter(station_name == "Dendermonde tij/Zeeschelde"),
              aes(x = Timestamp, y = Value),
              size = 1, color = "#2b8cbe") +
    scale_x_datetime(date_labels = "%d %b",
                     date_breaks = "1 days") +
    theme_minimal() +
    ylab("Water level\nDendermonde\n(m TAW)") +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          panel.grid.minor.y = element_blank(),
          panel.grid.minor.x = element_blank()) # remove x-label elements

# combine both plots to single image
ggarrange(tide_dendermonde, tidal_tracks,  
          ncol = 1, nrow = 2, common.legend = TRUE,
          align = "v", heights = c(1, 5))
```

Using the ridges, for each location the water level is plotted as function of time at that specific location.

Looking at the graph, Buttercup seems to be *lazy* and following the tidal movement for a while before setting of to the sea. When the water comes inland from the sea (higher water levels), Buttercup follows the water upstream. When the water returns to the sea again to low tide, Buttercup moves again to the direction of the sea.

By linking the eels tracking data with the tidal data, we get more insight to demistify the behaviour of these very interesting species. With the [wateRinfo](https://inbo.github.io/wateRinfo/) package, we hope to support researchers in answering a lot more questions.

For a more scientific approach to check the selective tidal stream transport of eel, check out the [scientific publication](https://www.sciencedirect.com/science/article/pii/S0272771418304530?via%3Dihub) by Pieter-Jan.

For the full code of this blogpost, check out [this repository](https://github.com/stijnvanhoey/wateRinfo_post).

**Acknowledgements:**

Thanks Buttercup for being our study objects and hopefully you had a save journey towards the sargasso sea. Thanks to Pieter-Jan Verhelst for the providing the data. 

We also would like to thank [Laura DeCicco](https://github.com/ldecicco-USGS) for reviewing the wateRinfo package as well as the editor [Karthik Ram](https://github.com/karthik).
